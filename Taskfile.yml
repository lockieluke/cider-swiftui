version: '3'

env:
  BKT_TTL: "5m"

vars:
  XC_PROJ: Cider.xcodeproj
  XC_ARCHIVE:
    sh: echo ${RUNNER_TEMP:-`pwd`}/dest/Cider.xcarchive
  # From: https://pewpewthespells.com/blog/xcode_deriveddata_hashes.html
  BUILD_DIR_DETERMINE_SCRIPT: "I2ltcG9ydCA8Q29tbW9uQ3J5cHRvL0NvbW1vbkNyeXB0by5oPgojaW1wb3J0IDxGb3VuZGF0aW9uL0ZvdW5kYXRpb24uaD4KCi8vIHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBzd2FwIGJ5dGUgb3JkZXJpbmcgb2YgYSA2NGJpdCBpbnRlZ2VyCnVpbnQ2NF90IHN3YXBfdWludDY0KHVpbnQ2NF90IHZhbCkgewogIHZhbCA9ICgodmFsIDw8IDgpICYgMHhGRjAwRkYwMEZGMDBGRjAwVUxMKSB8CiAgICAgICAgKCh2YWwgPj4gOCkgJiAweDAwRkYwMEZGMDBGRjAwRkZVTEwpOwogIHZhbCA9ICgodmFsIDw8IDE2KSAmIDB4RkZGRjAwMDBGRkZGMDAwMFVMTCkgfAogICAgICAgICgodmFsID4+IDE2KSAmIDB4MDAwMEZGRkYwMDAwRkZGRlVMTCk7CiAgcmV0dXJuICh2YWwgPDwgMzIpIHwgKHZhbCA+PiAzMik7Cn0KCi8qIQogICAgQGZ1bmN0aW9uIGhhc2hTdHJpbmdGb3JQYXRoCgogICAgQ3JlYXRlIHRoZSB1bmlxdWUgaWRlbnRpZmllciBzdHJpbmcgZm9yIGEgWGNvZGUgcHJvamVjdCBwYXRoCgogICAgQHBhcmFtIHBhdGggKGlucHV0KSBzdHJpbmcgcGF0aCB0byB0aGUgIi54Y29kZXByb2oiIG9yICIueGN3b3Jrc3BhY2UiIGZpbGUKCiAgICBAcmVzdWx0IE5TU3RyaW5nKiBvZiB0aGUgaWRlbnRpZmllcgoqLwpOU1N0cmluZyAqaGFzaFN0cmluZ0ZvclBhdGgoTlNTdHJpbmcgKnBhdGgpIHsKICAvLyB1c2luZyB1aW50NjRfdFsyXSBmb3IgZWFzZSBvZiB1c2UsIHNpbmNlIGl0IGlzIHRoZSBzYW1lIHNpemUgYXMKICAvLyBjaGFyW0NDX01ENV9ESUdFU1RfTEVOR1RIXQogIHVpbnQ2NF90IGRpZ2VzdFsyXSA9IHswfTsKCiAgLy8gY2hhciBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgaWRlbnRpZmllcgogIHVuc2lnbmVkIGNoYXIgcmVzdWx0U3RyWzI4XSA9IHswfTsKCiAgLy8gc2V0dXAgbWQ1IGNvbnRleHQKICBDQ19NRDVfQ1RYIG1kNTsKICBDQ19NRDVfSW5pdCgmbWQ1KTsKCiAgLy8gZ2V0IHRoZSBVVEY4IHN0cmluZyBvZiB0aGUgcGF0aAogIGNvbnN0IGNoYXIgKmNfcGF0aCA9IFtwYXRoIFVURjhTdHJpbmddOwoKICAvLyBnZXQgbGVuZ3RoIG9mIHRoZSBwYXRoIHN0cmluZwogIHVuc2lnbmVkIGxvbmcgbGVuZ3RoID0gc3RybGVuKGNfcGF0aCk7CgogIC8vIHVwZGF0ZSB0aGUgbWQ1IGNvbnRleHQgd2l0aCB0aGUgZnVsbCBwYXRoIHN0cmluZwogIENDX01ENV9VcGRhdGUoJm1kNSwgY19wYXRoLCBsZW5ndGgpOwoKICAvLyBmaW5hbGl6ZSB3b3JraW5nIHdpdGggdGhlIG1kNSBjb250ZXh0IGFuZCBzdG9yZSBpbnRvIHRoZSBkaWdlc3QKICBDQ19NRDVfRmluYWwoKGNvbnN0IGNoYXIgKilkaWdlc3QsICZtZDUpOwoKICAvLyB0YWtlIHRoZSBmaXJzdCA4IGJ5dGVzIG9mIHRoZSBkaWdlc3QgYW5kIHN3YXAgYnl0ZSBvcmRlcgogIHVpbnQ2NF90IHN0YXJ0VmFsdWUgPSBzd2FwX3VpbnQ2NChkaWdlc3RbMF0pOwoKICAvLyBmb3IgaW5kZXhlcyAxMy0+MAogIGludCBpbmRleCA9IDEzOwogIGRvIHsKICAgIC8vIHRha2UgJ3N0YXJ0VmFsdWUnIG1vZCAyNiAocmVzdHJpY3QgdG8gYWxwaGFiZXRpYykgYW5kIGFkZCBiYXNlZCAnYScKICAgIHJlc3VsdFN0cltpbmRleF0gPSAoY2hhcikoKHN0YXJ0VmFsdWUgJSAyNikgKyAnYScpOwoKICAgIC8vIGRpdmlkZSAnc3RhcnRWYWx1ZScgYnkgMjYKICAgIHN0YXJ0VmFsdWUgLz0gMjY7CgogICAgaW5kZXgtLTsKICB9IHdoaWxlIChpbmRleCA+PSAwKTsKCiAgLy8gVGhlIHNlY29uZCBsb29wLCB0aGlzIHRpbWUgdXNpbmcgdGhlIGxhc3QgOCBieXRlcwogIC8vIHJlcGVhdGluZyB0aGUgc2FtZSBwcm9jZXNzIGFzIGJlZm9yZSBidXQgb3ZlciBpbmRleGVzIDI3LT4xNAogIHN0YXJ0VmFsdWUgPSBzd2FwX3VpbnQ2NChkaWdlc3RbMV0pOwogIGluZGV4ID0gMjc7CiAgZG8gewogICAgcmVzdWx0U3RyW2luZGV4XSA9IChjaGFyKSgoc3RhcnRWYWx1ZSAlIDI2KSArICdhJyk7CiAgICBzdGFydFZhbHVlIC89IDI2OwogICAgaW5kZXgtLTsKICB9IHdoaWxlIChpbmRleCA+IDEzKTsKCiAgLy8gY3JlYXRlIGEgbmV3IHN0cmluZyBmcm9tIHRoZSAncmVzdWx0U3RyJyBjaGFyIGFycmF5IGFuZCByZXR1cm4KICByZXR1cm4gW1tOU1N0cmluZyBhbGxvY10gaW5pdFdpdGhCeXRlczpyZXN1bHRTdHIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aDoyOAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kaW5nOk5TVVRGOFN0cmluZ0VuY29kaW5nXTsKfQoKaW50IG1haW4oaW50IGFyZ2MsIGNvbnN0IGNoYXIgKmFyZ3ZbXSkgewogIE5TU3RyaW5nICpyZXN1bHQgPSBoYXNoU3RyaW5nRm9yUGF0aChbTlNTdHJpbmcgc3RyaW5nV2l0aFVURjhTdHJpbmc6YXJndlsxXV0pOwoKICBwcmludGYoIiVzXG4iLCBbcmVzdWx0IFVURjhTdHJpbmddKTsKfQo="
  DEST_PATH:
    sh: echo ${RUNNER_TEMP:-`pwd`}/dest
  CIDER_DEST_APP:
    sh: echo ${RUNNER_TEMP:-`pwd`}/dest/Cider.app
  XC_PROJECT_HASH:
    sh: $(command -v bkt >/dev/null 2>&1 && echo "bkt --ttl=5m --cwd --") echo "$HOME/Library/Developer/Xcode/DerivedData/Cider-"`echo "$(echo '{{ .BUILD_DIR_DETERMINE_SCRIPT }}' | base64 --decode)" > main.m; clang++ -framework Foundation main.m -o main &> /dev/null; ./main "$(pwd)/{{.XC_PROJ}}"""`
  DEBUG_BUILD_DIR:
    sh: echo "{{.XC_PROJECT_HASH}}/Build/Products/Debug"`rm main.m main 2> /dev/null`
  RELEASE_BUILD_DIR:
    sh: echo "{{.XC_PROJECT_HASH}}/Build/Products/Release"`rm main.m main 2> /dev/null`

tasks:
  default:
    desc: "Build, Run, Perform Tasks with Taskfile"
    silent: true
    cmds:
      - echo -e "Build, Run, Perform Tasks with Taskfile!\nRun 'task build-xc' to build Cider, consult README.md for documentation"

  quickstart:
    desc: "Quickstart command for setting everything up as a Cider developer"
    cmds:
      - brew bundle
      - task: install-deps:all-js
      - task: build:native-utils-lib
      - task: build:all-js
      - task: fetch:google-services
      - task: precompile:swift

  build:rs-native-utils-lib:
    desc: "Build Rust NativeUtils"
    dir: NativeUtils/
    sources:
      - src/**/*.rs
      - Cargo.toml
      - Cargo.lock
      - build.rs
      - build.sh
    generates:
      - target/universal/libnative_utils.a
    cmds:
      - sh build.sh

  build:native-utils-lib:
    desc: "Build NativeUtils"
    cmds:
      - task: build:rs-native-utils-lib

  clean:native-utils-lib:
    desc: "Clean NativeUtils's target folder"
    prompt: "Cleaning NativeUtils' target folder, do you want to continue?"
    dir: NativeUtils/
    cmds:
      - rm -rf target/
      - rm -rf build/

  install-deps:cider-web-modules-js:
    dir: 'CiderWebModules/'
    desc: "Install CiderWebModules' dependencies with Yarn"
    cmds:
      - yarn

  install-deps:all-js:
    desc: "Install all JS dependencies"
    cmds:
      - task: install-deps:cider-web-modules-js

  build:cider-web-modules-js:
    dir: 'CiderWebModules/'
    desc: "Build CiderWebModules"
    sources:
      - src/**/*
      - package.json
      - yarn.lock
    generates:
      - dist/**/*
    cmds:
      - yarn build

  build:all-js:
    cmds:
      - task: build:cider-web-modules-js

  precompile:swift:
    desc: "Precompile Swift source files with swift-precompiler"
    preconditions:
      - test -f "`which swift-precompiler`"
    sources:
      - Cider/**/*.swift
      - CiderPlaybackAgent/**/*.swift
    generates:
      - Precompiled.swift
    cmds:
      - swift-precompiler precompile "Cider/:CiderPlaybackAgent/" {{.CLI_ARGS}}

  build:xc:
    desc: "Build all targets including Cider and CiderPlaybackAgent"
    preconditions:
      - test -f "`which xcbeautify`"
    cmds:
      - set -o pipefail && xcodebuild -project {{.XC_PROJ}} -configuration Debug -sdk macosx -destination platform=macOS,arch=`arch` -scheme Cider build | xcbeautify`if [ -n "$GITHUB_ACTIONS" ]; then echo " --renderer github-actions"; fi`

  run:xc:
    desc: "Run Cider Debug"
    cmds:
      - open {{.DEBUG_BUILD_DIR}}/*.app

  run:xc-release:
    desc: "Run Cider Release"
    cmds:
      - open {{.RELEASE_BUILD_DIR}}/*.app

  open:xc-proj:
    desc: "Open Cider.xcodeproj"
    cmds:
      - open {{.XC_PROJ}}

  open:debug-build-dir:
    desc: "Open Debug build folder in Finder"
    cmds:
      - open {{.DEBUG_BUILD_DIR}}

  open:release-build-dir:
    desc: "Open Release build folder in Finder"
    cmds:
      - open {{.RELEASE_BUILD_DIR}}

  clean:xc:
    desc: "Clean Xcode build folder"
    prompt: "Cleaning Xcode build folder, do you want to continue?"
    preconditions:
      - test -f "`which xcbeautify`"
    cmds:
      - set -o pipefail && xcodebuild -project {{.XC_PROJ}} clean | xcbeautify`if [ -n "$GITHUB_ACTIONS" ]; then echo " --renderer github-actions"; fi`

  archive:xc:
    desc: "Archive Cider Release"
    generates:
      - "{{.XC_ARCHIVE}}"
    preconditions:
      - test -f "`which xcbeautify`"
    cmds:
      - |
        if [ -n "$GITHUB_ACTIONS" ] && [ -n "$RUNNER_TEMP" ]; then
          echo "Exporting archive to {{.XC_ARCHIVE}} on CI"
        fi
      - rm -rf {{.XC_ARCHIVE}}
      - set -o pipefail && xcodebuild -project {{.XC_PROJ}} -scheme "Cider - Release" archive -allowProvisioningUpdates -configuration Release -sdk macosx -destination platform=macOS,name="Any Mac" -archivePath {{.XC_ARCHIVE}} | xcbeautify`if [ -n "$GITHUB_ACTIONS" ]; then echo " --renderer github-actions"; fi`

  archive:build-app-bundle:
    desc: "Export .app bundle from .xcarchive"
    sources:
      - "{{.XC_ARCHIVE}}"
    generates:
      - "{{.CIDER_DEST_APP}}"
    preconditions:
      - test -f "`which xcbeautify`"
    cmds:
      - rm -rf {{.CIDER_DEST_APP}}
      - set -o pipefail && xcodebuild -exportArchive -archivePath {{.XC_ARCHIVE}} -exportPath {{.DEST_PATH}} -exportOptionsPlist ExportOptions.plist | xcbeautify`if [ -n "$GITHUB_ACTIONS" ]; then echo " --renderer github-actions"; fi`

  build:dmg:
    desc: "Build DMG for input .app"
    preconditions:
      - test -f "`which create-dmg`"
      - test -d {{.CIDER_DEST_APP}}
    vars:
      DEST_DMG_CIDER_APP: "{{.DEST_PATH}}/dmg/Cider.app"
      DEST_DMG_PATH: "{{.DEST_PATH}}/Cider.dmg"
      DMG_TITLE: "Cider"
    cmds:
      - |
        if [ -f "{{.DEST_DMG_PATH}}" ]; then
          rm "{{.DEST_DMG_PATH}}"
        fi
      - rm -rf "{{.DEST_PATH}}/dmg/"
      - mkdir -p "{{.DEST_PATH}}/dmg/"
      - cp -R {{.CIDER_DEST_APP}} "{{.DEST_DMG_CIDER_APP}}"
      - defer: rm -rf "{{.DEST_PATH}}/dmg/"
      - test -d /Volumes/Cider && diskutil eject /Volumes/Cider || true
      - create-dmg --volname "{{.DMG_TITLE}}" --volicon assets/icon.icns --background assets/bg.tiff --window-pos 200 120 --window-size 540 380 --icon-size 100 --icon "Cider.app" 120 210 --hide-extension "Cider.app" --app-drop-link 410 210 "{{.DEST_DMG_PATH}}" "{{.DEST_PATH}}/dmg"

  fetch:google-services:
    desc: "Fetch GoogleServices entitlements"
    cmds:
      - |
        source .env
        wget -O "./Cider/GoogleService-Info.plist" "$CIDER_GOOGLE_SERVICES_URL"
        wget -O "./CiderUpdateService/GoogleService-Info.plist" "$CIDER_UPDATE_SERVICE_GOOGLE_SERVICES_URL"

  scan:unused-code:
    desc: "Scan for unused code"
    cmds:
      - periphery scan

  sim:enable-stage-manager:
    desc: "Enable Stage Manager for running iPad simulator"
    cmds:
      - xcrun simctl spawn booted defaults write -g SBChamoisWindowingEnabled -bool YES

  sim:disable-stage-manager:
    desc: "Disable Stage Manager for running iPad simulator"
    cmds:
      - xcrun simctl spawn booted defaults write -g SBChamoisWindowingEnabled -bool NO

  kill:cider-playback-agent:
    aliases: [ kill-cpa ]
    desc: "Kill a hanging CiderPlaybackAgent process"
    cmds:
      - killall "CiderPlaybackAgent"
